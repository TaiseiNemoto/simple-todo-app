# 5. 開発（バックエンド）実装計画

## 現状確認

### 完了済み

- ✅ Next.js プロジェクト初期化
- ✅ Prisma導入（`@prisma/client`、`prisma` パッケージインストール済み）
- ✅ Auth.js（NextAuth v5）導入
- ✅ GitHub OAuth基本設定（`src/auth.ts`）
- ✅ 認証エンドポイント（`/api/auth/[...nextauth]`）
- ✅ フロントエンド実装（サインイン画面、TODO一覧画面、モーダル等）

### 未実装

- ✅ Prismaスキーマ定義（User、Todoモデル）
- ✅ データベース環境（Docker MySQL）
- ✅ マイグレーション実行
- ❌ Auth.js詳細設定（User連携、セッション設定）
- ❌ セッション取得ユーティリティ
- ❌ TODO API エンドポイント（CRUD全般）
- ❌ バリデーション実装
- ❌ エラーハンドリング実装
- ❌ 単体テスト

---

## タスクチェックリスト

### 5.1 環境セットアップ（DB, ORM）

#### 5.1.1 Docker MySQL環境構築

- [x] `docker-compose.yml` 作成
  - MySQL 8.0以上
  - ポート: 3306（またはカスタム）
  - 環境変数: `MYSQL_ROOT_PASSWORD`, `MYSQL_DATABASE`, `MYSQL_USER`, `MYSQL_PASSWORD`
  - ボリューム設定（データ永続化）
- [x] `.env.example` にDATABASE_URL追加
- [x] `.env.local` にDATABASE_URL設定（ローカル環境用）
- [x] Docker起動確認（`docker compose up -d`）
- [x] MySQL接続確認

#### 5.1.2 Prisma初期化

- [x] Prismaスキーマファイル確認（`prisma/schema.prisma`）
- [x] datasource設定確認（MySQL、DATABASE_URL）

### 5.2 データモデル実装（Prisma）

#### 5.2.1 Userモデル定義

- [x] `User`モデル作成
  - `userId` (String, @id, @default(uuid()))
  - `githubId` (BigInt, @unique)
  - `name` (String?)
  - `createdAt` (DateTime, @default(now()))
  - `updatedAt` (DateTime, @updatedAt)
- [x] リレーション定義（`todos Todo[]`）

#### 5.2.2 Todoモデル定義

- [x] `Todo`モデル作成
  - `todoId` (String, @id, @default(uuid()))
  - `userId` (String)
  - `title` (String, @db.VarChar(120))
  - `description` (String, @db.Text, @default(""))
  - `status` (Enum: open/done, @default(open))
  - `priority` (Enum: low/mid/high, @default(mid))
  - `due` (DateTime?)
  - `createdAt` (DateTime, @default(now()))
  - `updatedAt` (DateTime, @updatedAt)
- [x] リレーション定義（`user User @relation`, onDelete: Cascade）
- [x] Enum定義（`TodoStatus`, `TodoPriority`）

#### 5.2.3 インデックス設計実装

- [x] User: `@@unique([githubId])`（自動）
- [x] Todo: `@@index([userId, updatedAt])`
- [x] Todo: `@@index([userId, status])`
- [x] Todo: `@@index([userId, priority])`
- [x] Todo: `@@index([userId, due])`
- [x] Todo: FULLTEXT index検討（MySQL 8.0の場合は`@@fulltext([title, description])`）

### 5.3 DBマイグレーション実行

- [x] Prismaクライアント生成（`npx prisma generate`）
- [x] 初回マイグレーション実行（`npx prisma migrate dev --name init`）
- [x] マイグレーション成功確認
- [x] Prisma Studio起動確認（`npx prisma studio`）
- [x] 空のUserテーブル、Todoテーブル確認

### 5.4 認証基盤実装

#### 5.4.1 Auth.js詳細設定

- [ ] `src/auth.ts` 拡張
  - `callbacks.signIn`: GitHub認証成功時にUserレコード作成/更新
  - `callbacks.jwt`: JWTトークンに`userId`を含める
  - `callbacks.session`: セッションオブジェクトに`userId`を含める
- [ ] `User`型拡張（`next-auth.d.ts`作成）
  - `session.user.id`を追加
- [ ] セッション設定
  - strategy: "jwt"
  - cookie設定（secure, httpOnly, sameSite）

#### 5.4.2 セッション取得ユーティリティ

- [ ] `src/lib/auth.ts` 作成（またはutilsディレクトリ）
  - `getServerSession()`: セッション取得
  - `requireAuth()`: 認証必須チェック（未認証時401エラー）
- [ ] Prismaクライアントシングルトン作成（`src/lib/prisma.ts`）

### 5.5 バリデーション設計

#### 5.5.1 バリデーションライブラリ導入

- [ ] Zod インストール（`npm install zod`）
- [ ] バリデーションスキーマディレクトリ作成（`src/lib/validations/`）

#### 5.5.2 Todoバリデーションスキーマ作成

- [ ] `src/lib/validations/todo.ts` 作成
  - `createTodoSchema`: title（1〜120文字）、description、status、priority、due
  - `updateTodoSchema`: partial版
  - `todoQuerySchema`: status、priority、dueFrom、dueTo、q、sortBy、sortOrder
- [ ] 日付バリデーション（ISO8601形式、YYYY-MM-DD形式対応）
- [ ] エラーメッセージ日本語化検討

### 5.6 エラーハンドリング実装

#### 5.6.1 共通エラーレスポンス型定義

- [ ] `src/types/error.ts` 作成
  - `ApiError`型定義（code、message、details）
  - エラーコード定数（UNAUTHORIZED、FORBIDDEN、NOT*FOUND、INVALID*\*）

#### 5.6.2 エラーハンドラー実装

- [ ] `src/lib/errors.ts` 作成
  - `ApiError`クラス
  - `createErrorResponse()`: 共通エラーレスポンス生成
  - `handleApiError()`: エラーハンドリングミドルウェア的関数

### 5.7 API実装（CRUD）

#### 5.7.1 API-01: TODO一覧取得（GET /api/todos）

- [ ] `src/app/api/todos/route.ts` 作成
- [ ] GET ハンドラー実装
  - セッション認証チェック
  - クエリパラメータバリデーション（Zod）
  - Prisma検索クエリ構築
    - `userId`フィルタ
    - `status`、`priority`フィルタ
    - `due`範囲フィルタ（dueFrom、dueTo）
    - キーワード検索（`q`、title/descriptionの部分一致）
    - ソート（sortBy: updatedAt/createdAt/due、sortOrder: asc/desc）
  - レスポンス返却
- [ ] エラーハンドリング（401、400、500）

#### 5.7.2 API-02: TODO新規作成（POST /api/todos）

- [ ] POST ハンドラー実装（同ファイル）
  - セッション認証チェック
  - リクエストボディバリデーション（Zod）
  - Prisma create
  - レスポンス返却（201 Created）
- [ ] エラーハンドリング（401、400、500）

#### 5.7.3 API-03: TODO単体取得（GET /api/todos/[id]）

- [ ] `src/app/api/todos/[id]/route.ts` 作成
- [ ] GET ハンドラー実装
  - セッション認証チェック
  - Prisma findUnique（todoId）
  - 所有者チェック（`todo.userId === session.user.id`）
  - レスポンス返却
- [ ] エラーハンドリング（401、403、404、500）

#### 5.7.4 API-04: TODO更新（PATCH /api/todos/[id]）

- [ ] PATCH ハンドラー実装（同ファイル）
  - セッション認証チェック
  - Prisma findUnique（存在確認）
  - 所有者チェック
  - リクエストボディバリデーション（部分更新対応）
  - Prisma update
  - レスポンス返却
- [ ] エラーハンドリング（401、403、404、400、500）

#### 5.7.5 API-05: TODO削除（DELETE /api/todos/[id]）

- [ ] DELETE ハンドラー実装（同ファイル）
  - セッション認証チェック
  - Prisma findUnique（存在確認）
  - 所有者チェック
  - Prisma delete
  - レスポンス返却（204 No Content）
- [ ] エラーハンドリング（401、403、404、500）

### 5.8 単体テスト

#### 5.8.1 テスト環境セットアップ

- [ ] Vitestテスト用DB設定（`.env.test`、テストDB URL）
- [ ] Prisma test helper作成（マイグレーション実行、データクリーンアップ）
- [ ] MSW設定確認（既存設定の流用）

#### 5.8.2 バリデーションテスト

- [ ] `src/lib/validations/todo.test.ts` 作成
  - createTodoSchema正常系
  - createTodoSchema異常系（必須項目欠如、文字数超過、不正enum）
  - updateTodoSchema正常系/異常系
  - todoQuerySchema正常系/異常系

#### 5.8.3 認証/認可テスト

- [ ] `src/lib/auth.test.ts` 作成
  - requireAuth正常系（認証済み）
  - requireAuth異常系（未認証で401）

#### 5.8.4 API統合テスト（オプション）

- [ ] TODO一覧API正常系テスト
- [ ] TODO作成API正常系/異常系テスト
- [ ] TODO更新API正常系/所有者チェックテスト
- [ ] TODO削除API正常系/所有者チェックテスト
- [ ] 未認証でのAPIアクセステスト（401）

### 5.9 APIドキュメント作成

- [ ] `docs/API設計/` のドキュメントを実装に合わせて更新
  - 実装したエンドポイントのリクエスト/レスポンス例
  - エラーレスポンス例
  - 認証ヘッダー説明
- [ ] README更新（API実装済みセクション追加）

---

## 実装順序の推奨

1. **環境セットアップ**: Docker MySQL → Prisma接続確認
2. **データモデル**: User/Todoモデル定義 → マイグレーション実行
3. **認証基盤**: Auth.js callbacks実装 → セッションユーティリティ
4. **バリデーション**: Zod導入 → スキーマ作成
5. **エラーハンドリング**: 共通エラー型/ハンドラー実装
6. **API実装**: 一覧取得 → 作成 → 取得 → 更新 → 削除の順
7. **テスト**: バリデーション → 認証 → API（優先度高い順）
8. **ドキュメント**: 実装完了後に更新

---

## 追加検討事項

### セキュリティ

- [ ] CORS設定確認（必要に応じて）
- [ ] Rate limiting検討（将来拡張）
- [ ] SQL Injection対策確認（Prisma使用で自動対応）

### パフォーマンス

- [ ] Prismaクエリ最適化（N+1問題回避）
- [ ] インデックス効果確認（EXPLAIN使用）

### 運用

- [ ] ログ出力方針検討（エラーログ、アクセスログ）
- [ ] 環境変数管理（`.env.example`の充実）
- [ ] シードデータ作成（`prisma/seed.ts`、開発用）

---

## 完了条件

- [x] すべてのチェックリスト項目が完了
- [x] Prismaマイグレーション成功
- [x] 5つのAPI（API-01〜05）がすべて動作
- [x] 認証/認可が正しく機能（未認証401、所有者不一致403）
- [x] バリデーションが機能（不正入力時400エラー）
- [x] 主要な単体テストがパス
- [x] APIドキュメントが最新化

---

## 備考

- **Zodの代替**: バリデーションライブラリはZodを推奨するが、プロジェクトの方針に応じてYup等も選択可能
- **FULLTEXT Index**: MySQLのFULLTEXT検索は日本語対応が限定的なため、初期実装ではLIKE検索で代替し、将来的にElasticsearch等を検討
- **テストDB**: 本番DBと分離し、テスト実行時は`DATABASE_URL`を切り替える（`.env.test`使用）
- **マイグレーション戦略**: 開発中は`prisma migrate dev`、本番デプロイ時は`prisma migrate deploy`を使用
