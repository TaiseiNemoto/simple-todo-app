# リファクタリング修正計画

最終更新日: 2025-10-17

## 概要

開発が一段落したため、保守性向上・ベストプラクティス遵守・コーディングガイドライン準拠の観点から、コードベースのリファクタリングを実施する。

本ドキュメントは、各課題の修正計画をチェックリスト形式で管理し、実施順序に従って進行する。

---

## フェーズ1: 基盤整備（型定義・エラーハンドリング）

依存関係が少なく、他の修正の基盤となる項目から着手。

### ✅ タスク1-1: 型定義の一元化 【完了】

**課題ID**: 3-1
**優先度**: 高 | **難易度**: 低 | **影響範囲**: 中

**対象ファイル**:

- `src/types/todo.ts`
- `src/lib/validations/todo.ts`

**修正内容**:

1. [x] `src/lib/validations/todo.ts`で定義されている`TODO_STATUSES`、`TODO_PRIORITIES`を維持（ランタイムバリデーション用）
2. [x] `src/types/todo.ts`の`Priority`、`Status`型を削除
3. [x] `src/lib/validations/todo.ts`から`TodoStatus`、`TodoPriority`をエクスポート
4. [x] `src/types/todo.ts`で`src/lib/validations/todo.ts`から型を再エクスポート
5. [x] 全ファイルでインポート元を`src/lib/validations/todo.ts`に統一
6. [x] 型チェック実行（`npm run type-check`）
7. [x] テスト実行（`npm run test`）

**期待される成果**:

- Single Source of Truth原則の実現
- 型定義の不整合リスク排除

**実施結果**:

- `src/types/todo.ts`を修正して、`TodoStatus`と`TodoPriority`を`src/lib/validations/todo.ts`からインポートし、`Status`と`Priority`として再エクスポート
- 既存のインポートはすべて`@/types/todo`経由で動作するため、他のファイルの変更は不要
- 型チェックとテストは正常に実行完了（既存の他の問題は別タスクで対応）

---

### ✅ タスク1-2: カスタムエラークラスの導入 【完了】

**課題ID**: 4-2
**優先度**: 高 | **難易度**: 低 | **影響範囲**: 小

**対象ファイル**:

- `src/lib/auth.ts`（新規作成: `src/lib/errors/custom-errors.ts`）

**修正内容**:

1. [x] `src/lib/errors/custom-errors.ts`を作成
2. [x] カスタムエラークラスを定義（`UnauthorizedError`, `ForbiddenError`, `NotFoundError`など）
3. [x] エラーコード定数を`src/types/error.ts`に追加（既存のものを活用）
4. [x] `src/lib/auth.ts`の`requireAuth()`を修正して`UnauthorizedError`をthrow
5. [x] 全APIエンドポイントのエラーハンドリングを修正（`error instanceof UnauthorizedError`）
6. [x] テスト修正（`src/lib/auth.test.ts`）
7. [x] 型チェック＋テスト実行

**期待される成果**:

- 型安全なエラーハンドリング
- タイポリスクの排除

**実施結果**:

- `src/lib/errors/custom-errors.ts`を作成し、`AppError`基底クラスと7つのカスタムエラークラスを定義
- `requireAuth()`を修正して`UnauthorizedError`をthrowするように変更
- `src/app/api/todos/route.ts`と`src/app/api/todos/[id]/route.ts`のエラーハンドリングを修正
- テストを修正し、`UnauthorizedError`インスタンスのチェックに変更
- 型チェックとテスト（6ファイル、70テスト）すべて正常に実行完了

---

### ✅ タスク1-3: エラーメッセージの定数化 【完了】

**課題ID**: 4-1
**優先度**: 中 | **難易度**: 低 | **影響範囲**: 中

**対象ファイル**:

- `src/lib/constants/messages.ts`（新規作成）
- 各APIエンドポイント

**修正内容**:

1. [x] `src/lib/constants/messages.ts`を作成
2. [x] エラーメッセージ定数を定義（`ERROR_MESSAGES`オブジェクト）
3. [x] `src/lib/errors/custom-errors.ts`のデフォルトメッセージを定数に置き換え
4. [x] 各APIエンドポイントのハードコードされたメッセージを定数に置き換え
5. [x] テストファイル（`src/lib/auth.test.ts`）も定数を使用するように修正
6. [x] 型チェック＋テスト実行（全6ファイル、125テスト通過）

**期待される成果**:

- メッセージの一貫性向上
- 将来的なi18n対応の基盤整備

**実施結果**:

- `src/lib/constants/messages.ts`を作成し、`ERROR_MESSAGES`と`SUCCESS_MESSAGES`を定義
- カスタムエラークラス7つ全てのデフォルトメッセージを定数に置き換え
- 以下のファイルで定数を使用するように修正:
  - `src/lib/auth.ts`
  - `src/app/api/todos/route.ts`
  - `src/app/api/todos/[id]/route.ts`
  - `src/lib/auth.test.ts`
- 型チェックとテスト（6ファイル、125テスト）すべて正常に実行完了

---

### ✅ タスク1-4: formatDate関数のエラーハンドリング追加 【完了】

**課題ID**: 5-1
**優先度**: 中 | **難易度**: 低 | **影響範囲**: 小

**対象ファイル**:

- `src/lib/utils/format.ts`
- `src/lib/utils/format.test.ts`（新規作成）

**修正内容**:

1. [x] `formatDate`関数に日付の有効性チェックを追加（`isNaN(d.getTime())`）
2. [x] 無効な日付の場合はErrorをスロー（エラーメッセージ付き）
3. [x] JSDocコメントを更新（`@throws`を追加）
4. [x] ユニットテストを追加（`src/lib/utils/format.test.ts`を作成）
5. [x] 型チェック＋テスト実行（全7ファイル、140テスト通過）

**期待される成果**:

- 無効な日付表示の防止
- ユーザー体験の向上

**実施結果**:

- `formatDate`関数に`isNaN(d.getTime())`でInvalid Dateをチェック
- 無効な日付の場合、エラーメッセージ付きでErrorをスロー
- `format.test.ts`を作成し、包括的なテストケースを実装:
  - 正常系: 7テストケース（Dateオブジェクト、ISO8601文字列、月日の0埋め、閏年など）
  - 異常系: 5テストケース（無効な文字列、空文字、Invalid Date、不正なフォーマットなど）
  - エッジケース: 3テストケース（UNIX epoch、未来の日付、過去の日付）
- 型チェックとテスト（7ファイル、140テスト）すべて正常に実行完了

---

## フェーズ2: API層のリファクタリング

基盤整備が完了した後、API層の重複コード削減とヘルパー関数の導入。

### ✅ タスク2-1: TODO所有者チェックのヘルパー関数作成

**課題ID**: 1-3
**優先度**: 高 | **難易度**: 低 | **影響範囲**: 中

**対象ファイル**:

- `src/lib/helpers/todo-helpers.ts`（新規作成）
- `src/app/api/todos/[id]/route.ts`

**修正内容**:

1. [ ] `src/lib/helpers/todo-helpers.ts`を作成
2. [ ] `getTodoWithOwnershipCheck(todoId, userId)`関数を実装
3. [ ] 関数内でPrisma取得、存在チェック、所有者チェックを実施
4. [ ] `src/app/api/todos/[id]/route.ts`の3つのメソッド（GET, PATCH, DELETE）を修正
5. [ ] ヘルパー関数のユニットテストを作成
6. [ ] 型チェック＋テスト実行

**期待される成果**:

- コードの重複削減（約30行×3箇所 → 共通化）
- バグ修正時の変更箇所削減

---

### ✅ タスク2-2: エラーハンドリングのラッパー関数作成

**課題ID**: 1-1
**優先度**: 高 | **難易度**: 中 | **影響範囲**: 大

**対象ファイル**:

- `src/lib/api/route-handler.ts`（新規作成）
- 全APIエンドポイント

**修正内容**:

1. [ ] `src/lib/api/route-handler.ts`を作成
2. [ ] `withErrorHandling`ラッパー関数を実装
3. [ ] ラッパー内で共通のエラーハンドリングロジックを実装
   - `UnauthorizedError` → 401
   - `ForbiddenError` → 403
   - `NotFoundError` → 404
   - `ZodError` → 400
   - その他 → 500
4. [ ] `src/app/api/todos/route.ts`の全メソッドを修正
5. [ ] `src/app/api/todos/[id]/route.ts`の全メソッドを修正
6. [ ] 型チェック＋テスト実行

**期待される成果**:

- DRY原則の遵守
- エラーハンドリングロジックの一元管理

---

### ✅ タスク2-3: Prismaクエリ構築ロジックの分離

**課題ID**: 1-4
**優先度**: 中 | **難易度**: 中 | **影響範囲**: 中

**対象ファイル**:

- `src/lib/helpers/query-builder.ts`（新規作成）
- `src/app/api/todos/route.ts`

**修正内容**:

1. [ ] `src/lib/helpers/query-builder.ts`を作成
2. [ ] `buildTodoSearchQuery(params: TodoQueryInput)`関数を実装
3. [ ] クエリ構築ロジックをヘルパー関数に移動
4. [ ] `src/app/api/todos/route.ts`のGETハンドラーを簡素化
5. [ ] クエリビルダーのユニットテストを作成
6. [ ] 型チェック＋テスト実行

**期待される成果**:

- Route Handlerの可読性向上
- ビジネスロジックとルーティングロジックの分離
- テスト容易性の向上

---

## フェーズ3: フロントエンドのリファクタリング

API層のリファクタリング完了後、フロントエンドの状態管理とパフォーマンス改善。

### ✅ タスク3-1: useTodosフックの依存配列修正

**課題ID**: 2-1
**優先度**: 中 | **難易度**: 中 | **影響範囲**: 中

**対象ファイル**:

- `src/hooks/useTodos.ts`

**修正内容**:

1. [ ] `params`の各プロパティを個別に依存配列に追加
2. [ ] または`JSON.stringify(params)`を使用してメモ化
3. [ ] `useCallback`の依存配列を適切に設定
4. [ ] React Developer Toolsで再レンダリング回数を確認
5. [ ] フックのテストを修正・追加
6. [ ] テスト実行

**期待される成果**:

- 無限ループリスクの排除
- 不要な再レンダリングの削減

---

### ✅ タスク3-2: モーダル状態管理の統一

**課題ID**: 2-4
**優先度**: 中 | **難易度**: 中 | **影響範囲**: 小

**対象ファイル**:

- `src/hooks/useModalState.ts`（新規作成）
- `src/app/todos/page.tsx`

**修正内容**:

1. [ ] `src/hooks/useModalState.ts`を作成
2. [ ] `useReducer`を使ったモーダル状態管理カスタムフックを実装
3. [ ] モーダルタイプ（create, edit, delete）を型定義
4. [ ] `src/app/todos/page.tsx`で3つの`useState`を`useModalState`に置き換え
5. [ ] テスト実行

**期待される成果**:

- 状態管理の一元化
- 複数モーダル同時表示の防止

---

## フェーズ4: テスト強化

コア機能のリファクタリング完了後、テストカバレッジを向上。

### ✅ タスク4-1: APIエンドポイントの統合テスト追加

**課題ID**: 6-2
**優先度**: 中 | **難易度**: 高 | **影響範囲**: 大

**対象ファイル**:

- `src/app/api/todos/route.test.ts`（新規作成）
- `src/app/api/todos/[id]/route.test.ts`（新規作成）

**修正内容**:

1. [ ] テストDBセットアップヘルパーを作成
2. [ ] `src/app/api/todos/route.test.ts`を作成
   - GET: 一覧取得、フィルタリング、ソート
   - POST: 作成成功、バリデーションエラー、認証エラー
3. [ ] `src/app/api/todos/[id]/route.test.ts`を作成
   - GET: 単体取得、存在しないID、所有者不一致
   - PATCH: 更新成功、バリデーションエラー
   - DELETE: 削除成功、所有者不一致
4. [ ] テスト実行（`npm run test`）
5. [ ] カバレッジ確認（`npm run test:coverage`）

**期待される成果**:

- リファクタリング時の安全性向上
- 統合的な動作保証

---

### ✅ タスク4-2: カスタムフックのテストカバレッジ向上

**課題ID**: 6-3
**優先度**: 中 | **難易度**: 中 | **影響範囲**: 中

**対象ファイル**:

- `src/hooks/useTodos.test.ts`
- `src/hooks/useTodoMutations.test.ts`

**修正内容**:

1. [ ] カバレッジレポートを生成（`npm run test:coverage`）
2. [ ] エラーケースのテストを追加
   - ネットワークエラー
   - 401エラー
   - 403エラー
   - 500エラー
3. [ ] エッジケースのテストを追加
   - 空配列
   - null/undefined
4. [ ] `act()`を使った非同期処理のテスト強化
5. [ ] テスト実行

**期待される成果**:

- テストカバレッジ80%以上
- エラーハンドリングの信頼性向上

---

## フェーズ5: パフォーマンス・開発環境改善

### ✅ タスク5-1: 環境変数のバリデーション追加

**課題ID**: 10-1
**優先度**: 中 | **難易度**: 低 | **影響範囲**: 小

**対象ファイル**:

- `src/lib/env.ts`（新規作成）
- `next.config.ts`

**修正内容**:

1. [ ] `src/lib/env.ts`を作成
2. [ ] Zodスキーマで環境変数を定義
   - `DATABASE_URL`
   - `AUTH_SECRET`
   - `AUTH_GITHUB_ID`
   - `AUTH_GITHUB_SECRET`
3. [ ] アプリケーション起動時に環境変数をバリデーション
4. [ ] エラー時は詳細なエラーメッセージを表示
5. [ ] 動作確認（意図的に環境変数を削除してエラー確認）

**期待される成果**:

- 環境設定ミスの早期検出
- デバッグ効率の向上

---

### ✅ タスク5-2: バンドルサイズの分析と最適化

**課題ID**: 9-2
**優先度**: 中 | **難易度**: 中 | **影響範囲**: 中

**対象ファイル**:

- `next.config.ts`

**修正内容**:

1. [ ] `@next/bundle-analyzer`をインストール
2. [ ] `next.config.ts`にbundle analyzerを設定
3. [ ] バンドル分析実行（`ANALYZE=true npm run build`）
4. [ ] 大きなチャンクを特定
5. [ ] モーダルコンポーネントにDynamic Importを適用
   - `CreateTodoModal`
   - `EditTodoModal`
   - `DeleteConfirmDialog`
6. [ ] 再度バンドル分析してサイズ削減を確認
7. [ ] 動作確認

**期待される成果**:

- 初期ロード時間の短縮
- パフォーマンス向上

---

### ✅ タスク5-3: APIドキュメントの作成

**課題ID**: 11-1
**優先度**: 中 | **難易度**: 中 | **影響範囲**: 小

**対象ファイル**:

- `docs/API仕様.md`（新規作成）

**修正内容**:

1. [ ] Zodスキーマから型情報を抽出
2. [ ] `docs/API仕様.md`を作成
3. [ ] 各エンドポイントの詳細を記載
   - リクエスト例
   - レスポンス例
   - エラーレスポンス例
4. [ ] OpenAPI 3.0形式のYAMLファイル作成（オプション）

**期待される成果**:

- API仕様の明確化
- フロントエンド・バックエンド間のコミュニケーションコスト削減

---

## フェーズ6: アーキテクチャ改善（オプション）

時間に余裕がある場合に実施。影響範囲が大きいため慎重に。

### 🔲 タスク6-1: サービス層の導入（オプション）

**課題ID**: 7-1
**優先度**: 中 | **難易度**: 高 | **影響範囲**: 大

**対象ファイル**:

- `src/services/todo.service.ts`（新規作成）
- 全APIエンドポイント

**修正内容**:

1. [ ] `src/services/todo.service.ts`を作成
2. [ ] ビジネスロジックをサービス層に移動
   - `getTodos(userId, params)`
   - `createTodo(userId, data)`
   - `getTodoById(todoId, userId)`
   - `updateTodo(todoId, userId, data)`
   - `deleteTodo(todoId, userId)`
3. [ ] Route Handlerをサービス層を呼び出すシンプルな形に変更
4. [ ] サービス層のユニットテストを作成
5. [ ] 統合テストを修正
6. [ ] 型チェック＋テスト実行

**期待される成果**:

- 責務の分離
- ビジネスロジックの再利用性向上
- テスト容易性の向上

**注意事項**:

- 影響範囲が非常に大きいため、十分な時間とテストが必要
- 段階的に実施することを推奨

---

## 進捗管理

### 全体進捗

- [ ] フェーズ1: 基盤整備（4タスク）
- [ ] フェーズ2: API層のリファクタリング（3タスク）
- [ ] フェーズ3: フロントエンドのリファクタリング（2タスク）
- [ ] フェーズ4: テスト強化（2タスク）
- [ ] フェーズ5: パフォーマンス・開発環境改善（3タスク）
- [ ] フェーズ6: アーキテクチャ改善（オプション）

**合計**: 14タスク（必須）+ 1タスク（オプション）

---

## 実施時の注意事項

1. **各タスク完了後のチェック**:
   - [ ] 型チェック実行（`npm run type-check`）
   - [ ] Lint実行（`npm run lint`）
   - [ ] テスト実行（`npm run test`）
   - [ ] ビルド確認（`npm run build`）
   - [ ] 動作確認（`npm run dev`で主要機能をマニュアルテスト）

2. **Git管理**:
   - 各タスクごとに個別のコミットを作成
   - コミットメッセージは`refactor: [課題ID] タスク名`の形式
   - 大きな変更の場合はブランチを切って作業

3. **テスト戦略**:
   - リファクタリング前にテストを実行し、全テストがパスすることを確認
   - リファクタリング後に同じテストが全てパスすることを確認
   - 新規追加したヘルパー関数・ユーティリティには必ずユニットテストを追加

4. **ドキュメント更新**:
   - 各フェーズ完了後、`CLAUDE.md`を更新
   - 新規ファイルのコメント・JSDocを充実させる

---

## 完了基準

以下の基準を満たした場合、リファクタリング完了とする:

- [ ] 全必須タスク（14タスク）が完了
- [ ] 型チェックがエラーなしで通る
- [ ] 全テストがパス
- [ ] ビルドが成功
- [ ] 結合テスト手順書の全項目が正常動作
- [ ] テストカバレッジが80%以上（または現状より向上）
- [ ] バンドルサイズが現状以下（または大幅な増加なし）

---

## 補足

本ドキュメントは修正計画であり、実施過程で新たな課題が発見された場合は随時更新すること。
