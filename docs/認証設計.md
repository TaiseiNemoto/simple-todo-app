## 前提
- 認証方式：GitHub OAuth（Auth.js / NextAuth を利用）
- 目的：複数ユーザーでの利用を想定し、**自分のTODOだけ**参照・操作可能にする。
- 対象：Next.js（フロント/バック同居）、ローカル環境実行。
---
## フロー概要
- 認証開始：S-01の「GitHubでサインイン」からOAuth認可画面へ遷移。
- 認可完了：Auth.js がコールバックでユーザー情報を受領し、セッションを確立。以後はセッション参照で利用。
- ログアウト：Auth.js 経由でセッション破棄。
---
## セッション方針
- 方式：Auth.js のセッション（Cookie ベース）を利用し、API 側は `getServerSession` 等で検証する。
- 有効期限：Auth.js 既定を採用（本プロジェクトでは最小構成のため個別チューニングは行わない）。
- 保存情報の最小化：アプリ内識別に必要な `userId`（GitHubのIDや内部ユーザーID）を持たせるに留める。
---
## 認可（Authorization）
- 原則：すべての TODO API は**認証必須**。
- スコープ：「本人のTODOのみ操作可」をAPI層で強制。各APIで `todo.ownerId === session.user.id` を必須チェック。
    - 一覧：ログインユーザー本人の TODO のみ返却。
    - 参照／更新／削除：ID指定時も**所有者照合**を実施。
---
## 未認証時の挙動
- UI：未認証で保護ページへアクセス → S-01（サインイン）へ誘導。
- API：`401 UNAUTHORIZED` を返却。共通エラーレスポンスの `code` は `UNAUTHORIZED`。
---
## エラーハンドリング（代表）
- 認証失敗／セッション無効：`401 UNAUTHORIZED`（`code: UNAUTHORIZED`）。
- 所有者不一致：`403 FORBIDDEN`（`code: FORBIDDEN`）。
- リソース不存在：`404 NOT_FOUND`（`code: NOT_FOUND`）。
- バリデーション不備：`400 INVALID_*` を利用。
---
## セキュリティ設定（最小）
- Cookie：`Secure`（HTTPS前提）、`HttpOnly`、`SameSite=Lax/Strict` を採用。
- OAuth スコープ：最小（例：`read:user` 程度）で十分。
- .env：GitHub Client ID / Secret を `.env` と `.env.example` に分離管理（値は `.env` のみ）。WBS の準備タスクで整備。
---
## 画面連携（要点）
- S-01：サインインボタン→OAuth開始。
- S-02：サインアウト導線を配置（セッション破棄）。
- エラー画面：セッション切れや致命的エラー時は S-05/06 の方針に準拠（リロード／トップへ戻る導線）。
---
## API 側実装ルール（ダイジェスト）
- すべての `/api/todos*` ハンドラで「①セッション取得→②認証判定→③所有者照合→④処理→⑤共通エラー形式で返却」を統一。
- 代表エンドポイント：一覧/作成/参照/更新/削除（API-01〜05）。
---
## テスト観点（最低限）
- 正常系：サインイン→一覧取得→作成→参照→更新→削除の一連が成功。
- 異常系：
    - 未認証で各APIを叩く→`401`。
    - 他ユーザーの TODO へアクセス→`403`。
    - 不正IDや不存在→`404`。